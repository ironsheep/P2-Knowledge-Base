% P2KB Foundation Style Package
% Common foundational elements for all P2 Knowledge Base documents
% Provides: Pandoc compatibility, basic formatting, core functionality
% Author: Iron Sheep Productions, LLC
% Version: 1.0

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{p2kb-foundation}[2025/08/25 P2KB Foundation Package v1.0]

% ==================== PANDOC COMPATIBILITY ====================
% CRITICAL: These MUST be defined before other packages are loaded

\makeatletter
\newcommand*{\real}[1]{#1}  % Fix for table calculations
\makeatother

% Define ALL common pandoc helper commands
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\newcommand{\passthrough}[1]{#1}

% Additional pandoc compatibility that might be needed
\providecommand{\subtitle}[1]{\gdef\@subtitle{#1}}
\providecommand{\institute}[1]{\gdef\@institute{#1}}
\providecommand{\titlegraphic}[1]{\gdef\@titlegraphic{#1}}

% Prevent pandoc from breaking with missing commands
\providecommand{\VerbatimFootnotes}{}
\providecommand{\DefineShortVerb}[1]{}
\providecommand{\UndefineShortVerb}[1]{}

% ==================== CORE PACKAGES ====================
% Essential packages needed by all P2KB documents

\RequirePackage[utf8]{inputenc}
\RequirePackage[T1]{fontenc}
\RequirePackage{lmodern}
\RequirePackage{microtype}
\RequirePackage{graphicx}

% ==================== IMAGE SCALING ====================
% Automatic image scaling to fit within page margins

% Set default scaling for all images
\setkeys{Gin}{width=\linewidth,height=0.8\textheight,keepaspectratio}

% Override for specific sizing when needed
\let\oldinclndegraphics\includegraphics
\renewcommand{\includegraphics}[2][]{%
  \begingroup
  \setkeys{Gin}{width=\linewidth,height=0.8\textheight,keepaspectratio}%
  \setkeys{Gin}{#1}%
  \oldinclndegraphics{#2}%
  \endgroup
}
\RequirePackage{longtable}
\RequirePackage{booktabs}
\RequirePackage{array}
\RequirePackage{multirow}
\RequirePackage{xcolor}
\RequirePackage{hyperref}
\RequirePackage{fancyhdr}
\RequirePackage{titlesec}
\RequirePackage{tocloft}
\RequirePackage{float}
\RequirePackage[english]{babel}
\RequirePackage[top=0.75in,bottom=1in,left=1in,right=1in]{geometry}
\RequirePackage{tcolorbox}
\RequirePackage{calc}  % Mathematical calculations
\RequirePackage{needspace}  % Ensure space for content blocks

% Load tcolorbox libraries
\tcbuselibrary{skins,breakable}

% ==================== BASIC TYPOGRAPHY ====================
% Common typography settings for all documents

\setlength{\parindent}{0pt}
\setlength{\parskip}{10pt}
\linespread{1.3}

% ==================== TABLE OF CONTENTS ====================
% Standard TOC formatting for all documents

\setlength{\cftbeforechapskip}{10pt}
\renewcommand{\cftchapfont}{\bfseries}
\renewcommand{\cftsecfont}{\normalfont}
\renewcommand{\cftsubsecfont}{\normalfont\small}

% TOC depth: show up to subsections
\setcounter{tocdepth}{2}
% Section numbering: DISABLE auto-numbering (headings already contain numbers)
\setcounter{secnumdepth}{-1}

% ==================== TABLE FORMATTING ====================
% Better table defaults for all documents

\renewcommand{\arraystretch}{1.2}
\setlength{\tabcolsep}{8pt}

% ==================== BASIC PAGE SETUP ====================
% Standard headers and footers structure

\pagestyle{fancy}
\fancyhf{}
% Note: Actual header/footer content defined in presentation layers

% ==================== HYPERREF SETUP ====================
% Standard link formatting

\hypersetup{
  colorlinks=true,
  linkcolor=blue,
  urlcolor=blue,
  citecolor=blue,
  hidelinks=false
}

% ==================== CODE ENVIRONMENTS ====================
% Basic code block support (styling defined in content layers)

% Handle Pandoc's code blocks with proper spacing and rounded corners
\newenvironment{Shaded}{%
  \par\needspace{4\baselineskip}% Ensure space for code block
  \vspace{1.5\baselineskip}% Extra space after headings
  \begin{tcolorbox}[
    boxrule=0pt,
    colback=gray!10,
    rounded corners,
    left=10pt,
    right=10pt,
    top=8pt,
    bottom=8pt,
    before skip=15pt,
    after skip=15pt
  ]
}{%
  \end{tcolorbox}%
  \par\vspace{\baselineskip}% Add space after code block
}

% Code listing basic setup (colors and languages defined in content layers)
\RequirePackage{listings}
\lstset{
  basicstyle=\footnotesize\ttfamily,
  numbers=left,
  numberstyle=\tiny\color{gray},
  stepnumber=1,
  numbersep=10pt,
  xleftmargin=0pt,
  framexleftmargin=25pt,
  breaklines=true,
  breakatwhitespace=false,
  tabsize=2,
  captionpos=b,
  keepspaces=true,
  showspaces=false,
  showstringspaces=false,
  showtabs=false,
  backgroundcolor=\color{gray!10},
  frame=single,
  frameround=tttt,
  rulecolor=\color{gray!10},
  framesep=0pt
}

% ==================== CHAPTER FORMATTING BASE ====================
% Basic chapter structure (specific formatting in content layers)

% Chapter title formatting - no auto-numbering, headings contain numbers already
\titleformat{\chapter}[display]
  {\normalfont\huge\bfseries}
  {}  % No chapter number prefix
  {0pt}
  {\Huge}

% Minimal chapter spacing for better page utilization
\titlespacing*{\chapter}{0pt}{10pt}{20pt}

% Advanced chapter handling - supports all Pandoc variations
\RequirePackage{xparse}

% Conditional chapter page breaks - only break if not after part
\newif\ifafterpart
\afterpartfalse

\let\oldchapter\chapter
\RenewDocumentCommand{\chapter}{s o m}{%
  % Apply our custom page break logic first
  \ifafterpart
    \afterpartfalse% Reset flag after use
    % No page break, no page style change - let chapter flow after part
  \else
    \clearpage% Only break if not after part
  \fi
  
  % Check for specific unnumbered chapters
  \def\tempchaptertitle{#3}
  \def\execsummary{Executive Summary \{.unnumbered\}}
  \def\quickstart{Quick Start Guide \{.unnumbered\}}
  
  % Call appropriate chapter variant based on parameters and title
  \IfBooleanTF{#1}{%
    % Starred variant: \chapter*{title}
    \oldchapter*{#3}%
  }{%
    % Check if this should be unnumbered
    \ifx\tempchaptertitle\execsummary
      \oldchapter*{Executive Summary}%
    \else\ifx\tempchaptertitle\quickstart
      \oldchapter*{Quick Start Guide}%
    \else
      % Normal numbered chapter
      \IfValueTF{#2}{%
        % Optional parameter present: \chapter[short]{title}
        \oldchapter[#2]{#3}%
      }{%
        % Simple form: \chapter{title}
        \oldchapter{#3}%
      }%
    \fi\fi
  }%
  \thispagestyle{plain}% All chapters get headers
}

% Part formatting - conditional page break, set flag for next chapter
\let\oldpart\part
\RenewDocumentCommand{\part}{s o m}{%
  \clearpage% Only single page break (not double)
  \thispagestyle{empty}% Parts get no headers
  % Call appropriate part variant based on parameters
  \IfBooleanTF{#1}{%
    % Starred variant: \part*{title}
    \oldpart*{#3}%
  }{%
    % Non-starred variants
    \IfValueTF{#2}{%
      % Optional parameter present: \part[short]{title}
      \oldpart[#2]{#3}%
    }{%
      % Simple form: \part{title}
      \oldpart{#3}%
    }%
  }%
  \afterparttrue% Set flag for next chapter (no counter reset - headings have numbers)
}

% Part formatting - no auto-numbering, headings contain numbers already
\titleformat{\part}[display]
  {\normalfont\LARGE\bfseries\centering}
  {}  % No part number prefix
  {0pt}
  {\huge}
\titlespacing*{\part}{0pt}{0pt}{40pt}

% ==================== SECTION NUMBERING CONFIGURATION ====================
% Enable section numbering within chapters (1.1, 1.2, etc.)
\setcounter{secnumdepth}{2}  % Number sections only, subsections unnumbered  
\setcounter{tocdepth}{2}     % Include numbered sections in TOC

% Force subsection numbering off (extra safety)
\renewcommand{\thesubsection}{}  % Remove subsection numbers completely

% Configure section numbering format
% Chapters: 1, 2, 3... (already handled by default)
% Sections: 1.1, 1.2, 1.3... (numbered)
% Subsections: Unnumbered (just titles)

% Reset section counter for each chapter (default behavior)
% \@addtoreset{section}{chapter} % This is already default in book class

% ==================== HEADER CONFIGURATION ====================
% Option C: Headers on chapter pages but not part pages
% Fix header content to show clean chapter titles only

% Custom page styles
\fancypagestyle{plain}{%  % Used by chapters
  \fancyhf{}%
  \fancyhead[L]{\nouppercase{\leftmark}}%  % Left: chapter title
  \fancyhead[R]{\thepage}%  % Right: page number
  \renewcommand{\headrulewidth}{0.4pt}%
}%

\fancypagestyle{empty}{%  % Used by parts
  \fancyhf{}%
  \renewcommand{\headrulewidth}{0pt}%
}%

% Fix chapter mark to show clean titles (no prefixes)
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}  % Just the chapter title, no "Chapter X:"
\renewcommand{\sectionmark}[1]{}  % Disable section marks to avoid conflicts

% Handle missing commands gracefully
% Note: needspace package now properly loaded above

% ==================== PANDOC SYNTAX HIGHLIGHTING ====================
% Minimal syntax highlighting support

\RequirePackage{fancyvrb}

% Define all *Tok commands as pass-through (no coloring by default)
\providecommand{\AlertTok}[1]{#1}
\providecommand{\AnnotationTok}[1]{#1}
\providecommand{\AttributeTok}[1]{#1}
\providecommand{\BaseNTok}[1]{#1}
\providecommand{\BuiltInTok}[1]{#1}
\providecommand{\CharTok}[1]{#1}
\providecommand{\CommentTok}[1]{#1}
\providecommand{\CommentVarTok}[1]{#1}
\providecommand{\ConstantTok}[1]{#1}
\providecommand{\ControlFlowTok}[1]{#1}
\providecommand{\DataTypeTok}[1]{#1}
\providecommand{\DecValTok}[1]{#1}
\providecommand{\DocumentationTok}[1]{#1}
\providecommand{\ErrorTok}[1]{#1}
\providecommand{\ExtensionTok}[1]{#1}
\providecommand{\FloatTok}[1]{#1}
\providecommand{\FunctionTok}[1]{#1}
\providecommand{\ImportTok}[1]{#1}
\providecommand{\InformationTok}[1]{#1}
\providecommand{\KeywordTok}[1]{#1}
\providecommand{\NormalTok}[1]{#1}
\providecommand{\OperatorTok}[1]{#1}
\providecommand{\OtherTok}[1]{#1}
\providecommand{\PreprocessorTok}[1]{#1}
\providecommand{\RegionMarkerTok}[1]{#1}
\providecommand{\SpecialCharTok}[1]{#1}
\providecommand{\SpecialStringTok}[1]{#1}
\providecommand{\StringTok}[1]{#1}
\providecommand{\VariableTok}[1]{#1}
\providecommand{\VerbatimStringTok}[1]{#1}
\providecommand{\WarningTok}[1]{#1}
\providecommand{\VerbBar}{|}
\providecommand{\VERB}[1]{#1}

% For Pandoc's line numbering
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{%
  numbers=left,%
  numberstyle=\tiny\color{gray},%
  numbersep=5pt,%
  frame=single,%
  framesep=10pt,%
  formatcom=\color{black},%
  xleftmargin=2em,%
  xrightmargin=0pt%
}