% P2KB Smart Pins Content Layer
% Smart Pin specific environments and code block styling
% Author: Iron Sheep Productions, LLC
% Version: 1.0

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{p2kb-smart-pins-content}[2025/08/25 P2KB Smart Pins Content Layer v1.0]

% Load foundation layer first - this provides structural fixes
\RequirePackage{p2kb-foundation}

% ==================== PRESERVE FOUNDATION STRUCTURAL FIXES ====================
% CRITICAL: These ensure proper part/chapter numbering and page breaks
% The foundation layer provides these - we must not override them

% Foundation provides:
% - \thepart = \arabic{part} (shows "Part 1" not "0.2 Part I:")
% - Chapter page breaks with \ifafterpart logic
% - Part page breaks with chapter counter reset
% - Proper section numbering depth (tocdepth=2, secnumdepth=2)
% - Chapter header formatting without prefix issues

% DO NOT override these foundation commands:
% \renewcommand{\thepart}{...}     % Foundation handles this correctly
% \renewcommand{\chapter}{...}     % Foundation handles page breaks
% \renewcommand{\part}{...}        % Foundation handles counter reset
% \titleformat{\chapter}{...}      % Foundation provides proper format

% ==================== SMART PINS CODE BLOCKS ====================
% Override foundation's Shaded environment with Smart Pin specific styling
% PRESERVE: Foundation's spacing and structural logic, CHANGE: Only colors/borders

\renewenvironment{Shaded}{%
  \par\needspace{4\baselineskip}% Ensure space for code block
  \vspace{1.5\baselineskip}% Extra space after headings
  \begin{tcolorbox}[
    boxrule=1pt,
    colback=blue!8,           % Smart Pin blue theme
    colframe=blue!40,         % Blue border for Smart Pins
    rounded corners,
    left=15pt,                % Slightly more indentation
    right=10pt,
    top=8pt,
    bottom=8pt,
    before skip=15pt,
    after skip=15pt,
    breakable                 % Allow breaking across pages
  ]
}{%
  \end{tcolorbox}%
  \par\vspace{\baselineskip}% Add space after code block
}

% ==================== LEVEL-AWARE CODE BLOCKS ====================
% Different indentation levels for hierarchical content

\newtcolorbox{CodeLevel1}{
  boxrule=1pt,
  colback=blue!8,
  colframe=blue!40,
  rounded corners,
  left=15pt,                % Base indentation
  right=10pt,
  top=8pt,
  bottom=8pt,
  before skip=15pt,
  after skip=15pt,
  breakable
}

\newtcolorbox{CodeLevel2}{
  boxrule=1pt,
  colback=blue!6,           % Slightly lighter for sub-level
  colframe=blue!35,
  rounded corners,
  left=30pt,                % Double indentation for subsections
  right=10pt,
  top=8pt,
  bottom=8pt,
  before skip=15pt,
  after skip=15pt,
  breakable
}

\newtcolorbox{CodeLevel3}{
  boxrule=1pt,
  colback=blue!4,           % Even lighter for sub-sub-level
  colframe=blue!30,
  rounded corners,
  left=45pt,                % Triple indentation for sub-subsections
  right=10pt,
  top=8pt,
  bottom=8pt,
  before skip=15pt,
  after skip=15pt,
  breakable
}

% ==================== LIST-AWARE CODE BLOCKS ====================
% Code blocks that align with list content (not list markers)

% Base environments with list indentation added
\newtcolorbox{list-indent-1}{
  boxrule=1pt,
  colback=blue!8,
  colframe=blue!40,
  rounded corners,
  left=40pt,                % Align with numbered list content (\parindent + list indent)
  right=10pt,
  top=8pt,
  bottom=8pt,
  before skip=15pt,
  after skip=15pt,
  breakable
}

\newtcolorbox{list-indent-2}{
  boxrule=1pt,
  colback=blue!6,
  colframe=blue!35,
  rounded corners,
  left=65pt,                % Nested list indentation (40pt + 25pt)
  right=10pt,
  top=8pt,
  bottom=8pt,
  before skip=15pt,
  after skip=15pt,
  breakable
}

% Combined environments: heading level + list indentation
\newtcolorbox{CodeLevel2.list-indent-1}{
  boxrule=1pt,
  colback=blue!6,           % Section level color
  colframe=blue!35,
  rounded corners,
  left=55pt,                % Section indent (30pt) + list indent (25pt)
  right=10pt,
  top=8pt,
  bottom=8pt,
  before skip=15pt,
  after skip=15pt,
  breakable
}

\newtcolorbox{CodeLevel3.list-indent-1}{
  boxrule=1pt,
  colback=blue!4,           % Subsection level color
  colframe=blue!30,
  rounded corners,
  left=70pt,                % Subsection indent (45pt) + list indent (25pt)
  right=10pt,
  top=8pt,
  bottom=8pt,
  before skip=15pt,
  after skip=15pt,
  breakable
}

% ==================== P2 LANGUAGE DEFINITIONS ====================
% CRITICAL: Must include P2 syntax highlighting from reference content layer

% Define Spin2 language
\lstdefinelanguage{spin2}{
  keywords={CON, VAR, OBJ, PUB, PRI, DAT, repeat, if, else, elseif, case, 
            while, until, from, to, step, return, abort, next, quit,
            byte, word, long, res, file, org, end, fit},
  sensitive=true,
  comment=[l]{'},
  morecomment=[l]{//},
  string=[b]",
  morestring=[b]'
}

% Define PASM2 language
\lstdefinelanguage{pasm2}{
  keywords={org, res, long, word, byte, mov, add, sub, and, or, xor, not,
            shl, shr, sar, rol, ror, rcl, rcr, test, cmp, jmp, call, ret,
            djnz, tjz, tjnz, wrpin, wxpin, wypin, rdpin, rqpin, akpin, dirh,
            dirl, testp, waitx, rep, nop},
  sensitive=false,
  comment=[l]{'},
  morecomment=[l]{//},
  string=[b]",
  morestring=[b]'
}

% ==================== SMART PIN SPECIFIC ENVIRONMENTS ====================

% Try It Yourself boxes
\newtcolorbox{tryityourself}{
  title=Try It Yourself,
  fonttitle=\bfseries\color{white},
  colbacktitle=green!60!black,
  colback=green!5,
  colframe=green!60!black,
  boxrule=2pt,
  rounded corners,
  left=15pt,
  right=15pt,
  top=10pt,
  bottom=10pt,
  before skip=20pt,
  after skip=20pt,
  breakable,
  enhanced
}

% Pin Configuration callouts
\newtcolorbox{pinconfig}{
  title=Pin Configuration,
  fonttitle=\bfseries\color{white},
  colbacktitle=orange!70!black,
  colback=orange!5,
  colframe=orange!70!black,
  boxrule=2pt,
  rounded corners,
  left=15pt,
  right=15pt,
  top=10pt,
  bottom=10pt,
  before skip=20pt,
  after skip=20pt,
  breakable,
  enhanced
}

% Important Notes
\newtcolorbox{smartnote}{
  title=Important,
  fonttitle=\bfseries\color{white},
  colbacktitle=red!70!black,
  colback=red!5,
  colframe=red!70!black,
  boxrule=2pt,
  rounded corners,
  left=15pt,
  right=15pt,
  top=10pt,
  bottom=10pt,
  before skip=20pt,
  after skip=20pt,
  breakable,
  enhanced
}

% Technical Specifications
\newtcolorbox{techspec}{
  title=Technical Specification,
  fonttitle=\bfseries\color{white},
  colbacktitle=purple!70!black,
  colback=purple!5,
  colframe=purple!70!black,
  boxrule=2pt,
  rounded corners,
  left=15pt,
  right=15pt,
  top=10pt,
  bottom=10pt,
  before skip=20pt,
  after skip=20pt,
  breakable,
  enhanced
}