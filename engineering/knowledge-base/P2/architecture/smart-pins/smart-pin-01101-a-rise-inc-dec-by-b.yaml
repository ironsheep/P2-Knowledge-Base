# Smart Pin Mode: %01101 - A-Rise Inc/Dec by B-State  
# Silicon Doc Reference: part4-smart-pins.txt, pages 90-91
# Layer 1: Direct Silicon Doc extraction

mode_id: "%01101"

mode_name: "A-Rise Inc/Dec by B-State"

mode_group: "measurement"

mode_complexity: "intermediate" 

dac_mode_dependency: false

pin_pairing: "adjacent"

wrpin_configuration:
  base_format: "%AAAA_BBBB_FFF_MMMMMMMMMMMMM_TT_SSSSS_0"
  
  a_input_selector:
    description: "4-bit A input selector - signal with edges to count"
    bit_pattern: "%AAAA"
    options:
      - code: "%0000"
        description: "this pin's read state (edge signal)"
        polarity: "true"
        source: "pin_read"
      - code: "%0001"
        description: "relative +1 pin's read state"
        polarity: "true"
        source: "relative_pin"
      - code: "%0010"
        description: "relative +2 pin's read state" 
        polarity: "true"
        source: "relative_pin"
      - code: "%0011"
        description: "relative +3 pin's read state"
        polarity: "true"
        source: "relative_pin"
      - code: "%0100"
        description: "this pin's OUT bit from cogs"
        polarity: "true"
        source: "out_bit"
      - code: "%0101"
        description: "relative -3 pin's read state"
        polarity: "true"
        source: "relative_pin"
      - code: "%0110"
        description: "relative -2 pin's read state"
        polarity: "true"
        source: "relative_pin"
      - code: "%0111"
        description: "relative -1 pin's read state"
        polarity: "true"
        source: "relative_pin"
      - code: "%1xxx"
        description: "inverted versions of above"
        polarity: "inverted"
        source: "any"
  
  b_input_selector:
    description: "4-bit B input selector - direction signal (high=inc, low=dec)"
    bit_pattern: "%BBBB"
    options:
      - code: "%0000"
        description: "this pin's read state"
        polarity: "true"
        source: "pin_read"
      - code: "%0001"
        description: "relative +1 pin's read state (direction signal)"
        polarity: "true"
        source: "relative_pin"
      - code: "%0010"
        description: "relative +2 pin's read state"
        polarity: "true"
        source: "relative_pin"
      - code: "%0011"
        description: "relative +3 pin's read state"
        polarity: "true"
        source: "relative_pin"
      - code: "%0100"
        description: "this pin's OUT bit from cogs"
        polarity: "true"
        source: "out_bit"
      - code: "%0101"
        description: "relative -3 pin's read state"
        polarity: "true"
        source: "relative_pin"
      - code: "%0110"
        description: "relative -2 pin's read state"
        polarity: "true"
        source: "relative_pin"
      - code: "%0111"
        description: "relative -1 pin's read state"
        polarity: "true"
        source: "relative_pin"
      - code: "%1xxx"
        description: "inverted versions of above"
        polarity: "inverted"
        source: "any"

  input_logic_filtering:
    description: "3-bit input logic/filtering for clean directional counting"
    bit_pattern: "%FFF"
    options:
      - code: "%000"
        description: "A, B (default)"
        operation: "passthrough"
        filter_type: "none"
      - code: "%001"
        description: "A AND B, B"
        operation: "logical_and"
        filter_type: "none"
      - code: "%010"
        description: "A OR B, B"
        operation: "logical_or"
        filter_type: "none"
      - code: "%011"
        description: "A XOR B, B"
        operation: "logical_xor"
        filter_type: "none"
      - code: "%100"
        description: "A, B, both filtered using global filt0"
        operation: "passthrough"
        filter_type: "filt0"
      - code: "%101"
        description: "A, B, both filtered using global filt1"
        operation: "passthrough"
        filter_type: "filt1"
      - code: "%110"
        description: "A, B, both filtered using global filt2"
        operation: "passthrough"
        filter_type: "filt2"
      - code: "%111"
        description: "A, B, both filtered using global filt3"
        operation: "passthrough"
        filter_type: "filt3"

  low_level_control:
    description: "13-bit low-level pin control - input configuration"
    bit_pattern: "%M............"
    special_modes:
      - condition: "M[12:10] = %100"
        behavior: "ADC mode - not used for digital counting"

  dir_out_control:
    description: "2-bit pin DIR/OUT control - input operation"
    bit_pattern: "%TT"
    smart_off_behavior:
      non_dac_mode: []
      dac_mode: []
    smart_on_behavior:
      dac_modes: []
      non_dac_modes:
        - mode_range: "%01101 (A-rise inc/dec by B)"
          behavior: "Input-only directional counting"

x_parameter:
  usage: "Measurement period configuration"
  bit_fields:
    - range: "X[31:0]"
      purpose: "Measurement period in clock cycles"
      valid_values:
        min: 0
        max: 4294967295
        special_values:
          - value: 0
            meaning: "Continuous operation - running total always available"
          - value: 160000000
            meaning: "1-second measurement windows"

y_parameter:
  usage: "Not used in this mode"

z_result:
  data_type: "32-bit signed accumulator"
  bit_interpretation:
    - range: "Z[31:0]"
      meaning: "Signed count: increments on A-rise when B-high, decrements when B-low"
  flag_behavior: "C flag contains status information"
  overflow_handling: "32-bit signed arithmetic with wraparound"

operation_description: |
  This mode accumulates A-input positive edges with B-input supplying increment/decrement direction.
  On each A positive edge, if B is high the accumulator increments (+1), if B is low it decrements (-1).
  X[31:0] sets measurement period - if zero, continuous totalizer mode with running count always
  readable. If non-zero, events counted for that period then result placed in Z while accumulator
  set to 0/1/-1 value for seamless counting across periods. During reset, Z set to adder value (0/1/-1).

timing_specifications:
  clock_relationship: "Asynchronous to A edges, B sampled synchronously with A edges"
  base_period:
    description: "Measurement period or continuous operation"  
    min_clocks: 0
    max_clocks: 4294967295
  update_frequency: "Immediate response to A edges, periodic reporting if X > 0"
  settling_time: "Filter delay if global filtering enabled"

in_signal_behavior:
  trigger_conditions:
    - "Measurement period completion (periodic mode only)"
  acknowledgment_method: "rdpin"
  polling_restrictions: "2-clock delay after acknowledgment"


initialization_requirement:
  critical: true
  description: "Smart pin MUST be reset before configuration"
  requirement: |
    The smart pin MUST be reset (DIR=0) before any configuration or reconfiguration.
    This ensures the smart pin is in a known state and prevents configuration conflicts.
  reset_sequence:
    pasm2: |
      DIRL  pin         ' REQUIRED: Reset smart pin (DIR=0)
      WRPIN mode, pin   ' Configure mode
      WXPIN x, pin      ' Set X parameter
      WYPIN y, pin      ' Set Y parameter
      DIRH  pin         ' Enable smart pin (DIR=1)
    spin2: |
      PINCLEAR(pin)              ' Reset pin (DIR=0, WRPIN=0)
      PINSTART(pin, mode, x, y)  ' Configure and enable
      ' OR manually:
      PINFLOAT(pin)              ' Ensure DIR=0
      WRPIN(pin, mode)           ' Set mode
      WXPIN(pin, x)              ' Set X parameter
      WYPIN(pin, y)              ' Set Y parameter
      PINHIGH(pin)               ' Enable (DIR=1)

reset_behavior:
  dir_low_effects:
    - "IN signal goes low"
    - "Z set to adder value (0/1/-1)"
  dir_transition_effects: "Begin directional counting on A edges"
  wrpin_zero_effects: "Return to normal mode"
  reset_requirement: "ALWAYS set DIR=0 before reconfiguring the smart pin"

common_applications:
  - application: "Directional step counting"
    description: "Count steps with direction control"
    complexity_level: "intermediate"
  - application: "Manual encoder simulation"
    description: "Emulate incremental encoder with separate step/direction"
    complexity_level: "intermediate"

configuration_examples:
  - name: "Step/direction motor feedback"
    description: "Count motor steps with direction"
    reset_code: "DIRL step_count                  ' REQUIRED: Reset before configuration"
    wrpin_code: "WRPIN ##%0000_0001_000_0000000000000_00_01101_0, step_count"
    wxpin_code: "WXPIN #0, step_count"
    explanation: "A=steps, B=direction, continuous counting"

related_modes:
  - mode_id: "%01011"
    relationship: "advanced_version"
    description: "Quadrature encoder - true quadrature decoding"
  - mode_id: "%01100"
    relationship: "complementary" 
    description: "Count A-rise with B-high - gating instead of direction"

related_instructions:
  - instruction: "WRPIN"
    usage_context: "Configure directional counting"
  - instruction: "WXPIN"
    usage_context: "Set measurement period"
  - instruction: "RDPIN/RQPIN"
    usage_context: "Read signed count"

hardware_considerations:
  power_implications: "Low power edge-triggered operation"
  pin_loading_effects: "Input-only, minimal loading"
  noise_considerations: "Filter both signals for reliable direction detection"
  thermal_effects: "Minimal heat generation"

extraction_metadata:
  extraction_date: "2025-09-06"
  source_documents:
    - document: "Silicon Doc part4-smart-pins.txt"
      pages: [90, 91]
      section: "%01101 = inc on A-rise & B-high / dec on A-rise & B-low"
  validation_status: "draft"
  completeness_score: 93
  technical_accuracy: "silicon_doc_verified"