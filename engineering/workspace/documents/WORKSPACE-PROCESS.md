# PDF Generation Workspace Process

## ⚠️ CRITICAL: Master vs Working Copy Distinction

**OPUS MASTER (Read-Only)**: `/documentation/manuals/[document]/`
- High-quality prose generated by Opus
- Expensive AI investment - MUST be preserved
- Read-only - never edit directly
- Source of truth for content quality

**WORKING COPY (Read/Write)**: `/exports/pdf-generation/workspace/[document]/`
- Derived from Opus master, becomes "production branch"
- Apply template integration fixes (remove manual TOC, LaTeX compatibility)
- Apply formatting adjustments based on visual review
- Evolves to become final processed version for PDF generation
- This is where Claude does iterative improvements

**PROCESS RULE**: Always start with clean copy from Opus master, then apply necessary processing fixes to working copy.

## Directory Structure

```
/exports/pdf-generation/
├── workspace/                    # ITERATION WORKSPACE (Claude's work area)
│   └── desilva-manual/          # Working on De Silva manual
│       ├── P2-PASM-deSilva-Style-FULL-Part1.md    # Master Part 1
│       ├── P2-PASM-deSilva-Style-Part2a.md        # Master Part 2a
│       ├── P2-PASM-deSilva-Style-Part2b.md        # Master Part 2b
│       ├── P2-PASM-deSilva-Style-Part2c.md        # Master Part 2c
│       └── p2kb-pasm-desilva.latex                # Master template
│
└── outbound/                     # DELIVERY FOLDERS (for user to grab)
    └── P2-PASM-deSilva-Style/   # Clean delivery folder
        └── (empty until delivery)
```

## Process Flow

### 1. Iteration Phase (in workspace/)
- Edit master markdown files
- Update template as needed
- Test and refine

### 2. Delivery Phase (to outbound/)
When ready for visual pass:
1. Run escaping script on markdown
2. Copy to outbound folder:
   - Escaped markdown (no "-escaped" suffix)
   - Template (if changed)
   - request.json
3. User grabs files (they disappear)
4. User generates PDF and provides feedback

### 3. Refinement Phase (back in workspace/)
- Apply feedback to masters
- Iterate until visually correct

### 4. Final Phase
- Combine all parts
- Final delivery to outbound
- Clean workspace after completion

## Key Rules

1. **workspace/** = Claude's iteration area (working copies live here)
2. **outbound/** = Delivery folders (stay clean, one per document)
3. **No "-escaped" suffix** = Escaping is implied for PDF generation
4. **Files disappear** = User has grabbed them for processing
5. **Template in both places** = Master in workspace, copy to outbound when changed
6. **Opus master is sacred** = Never edit, only copy from
7. **Working copy gets fixes** = Template integration, LaTeX compatibility

## ⚠️ Quality Gates - Apply to Working Copy

### MANDATORY Fixes Before PDF Generation:
- [ ] **Remove manual TOC** - LaTeX template generates TOC automatically
- [ ] **LaTeX character escaping** - Run latex-escape-all.sh script
- [ ] **Template compatibility** - Ensure markdown works with chosen template
- [ ] **Visual formatting** - Apply any presentation fixes from user feedback

### Small Piece Testing Protocol:
- [ ] **Create test subset** - Extract representative chapters for template validation
- [ ] **Perfect template on small piece** - Iterate quickly on limited content
- [ ] **Apply learnings to full content** - Scale validated template to complete working copy
- [ ] **Full deployment only after validation** - Reduces risk of large-scale failures

## Current Working Files

### De Silva Manual Working Copies (in workspace/desilva-manual/):
- Part 1: Chapters 1-4 (33KB)
- Part 2a: Chapters 5-8 (35KB)
- Part 2b: Chapters 9-12 (37KB)
- Part 2c: Chapters 13-16 + Appendices (64KB)
- Template: p2kb-pasm-desilva.latex

### Smart Pins Manual Working Copy (in workspace/smart-pins-manual/):
- P2-Smart-Pins-Complete-Reference.md
- Status: Needs quality gates applied (manual TOC removal)

### Why Split Files?
- Files over 50KB cause editing slowness
- Smaller files = faster iterations
- Combine only for final PDF generation

## Process Break Analysis - Manual TOC Issue

**Break Discovered**: 2025-08-25
**Issue**: Manual TOC found in both Opus master and working copy
**Impact**: Creates duplicate TOC in PDF (LaTeX generates TOC automatically)

**Root Cause**: Unclear - investigation needed
**Prevention**: Added quality gate to remove manual TOC from working copies
**Fix**: Remove `## Table of Contents` section from working copy before PDF generation